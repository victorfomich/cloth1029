<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRAZKE Admin</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background:#f4f4f5; margin:0; padding:0; }
        header { background:#111; color:#fff; padding:16px 24px; display:flex; justify-content:space-between; align-items:center; }
        header h1 { font-size:18px; letter-spacing:1px; text-transform:uppercase; }
        main { max-width:1100px; margin:24px auto; padding:0 16px 32px; }
        .card { background:#fff; border-radius:12px; padding:20px 20px 24px; box-shadow:0 10px 25px rgba(15,23,42,0.12); margin-bottom:20px; }
        .card h2 { margin:0 0 12px; font-size:18px; }
        .muted { color:#6b7280; font-size:14px; }
        .products-table { width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; }
        .products-table th, .products-table td { padding:8px 10px; border-bottom:1px solid #e5e7eb; text-align:left; vertical-align:top; }
        .products-table th { background:#f9fafb; font-weight:600; font-size:13px; }
        .badge { display:inline-flex; align-items:center; justify-content:center; padding:2px 8px; border-radius:999px; background:#111827; color:#fff; font-size:11px; }
        .btn { border-radius:999px; border:none; padding:8px 14px; font-size:13px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
        .btn-primary { background:#111827; color:#fff; }
        .btn-ghost { background:transparent; color:#111827; }
        .btn-danger { background:#fee2e2; color:#b91c1c; }
        .btn:disabled { opacity:0.6; cursor:default; }
        form .field { margin-bottom:12px; }
        .field label { display:block; font-size:13px; font-weight:500; margin-bottom:4px; }
        .field input, .field textarea { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #d1d5db; font-size:13px; box-sizing:border-box; }
        .field textarea { min-height:70px; resize:vertical; }
        .hint { font-size:12px; color:#9ca3af; margin-top:2px; }
        .pill { display:inline-flex; padding:2px 8px; border-radius:999px; background:#e5e7eb; font-size:11px; margin-right:4px; margin-bottom:4px; }
        .row-actions { display:flex; gap:6px; }
        .status-text { font-size:13px; color:#6b7280; margin-top:4px; }
        .status-text.error { color:#b91c1c; }
        .status-text.success { color:#16a34a; }
        .flex-row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; }
        a.link { color:#111827; text-decoration:underline; font-size:13px; }
        .form-section { border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 20px; }
        .form-section:first-child { border-top: none; padding-top: 0; margin-top: 0; }
        .form-section-title { font-size: 15px; font-weight: 600; margin-bottom: 16px; color: #111827; }
        .image-preview { max-width: 200px; max-height: 200px; margin-top: 8px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .size-table-editor { border: 1px solid #d1d5db; border-radius: 8px; padding: 16px; background: #f9fafb; margin-top: 8px; }
        .size-table-editor table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        .size-table-editor th, .size-table-editor td { padding: 8px; border: 1px solid #d1d5db; text-align: left; }
        .size-table-editor th { background: #fff; font-weight: 600; }
        .size-table-editor input { width: 100%; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; }
        .size-table-controls { margin-top: 12px; display: flex; gap: 8px; }
        .btn-small { padding: 4px 8px; font-size: 11px; }
        .image-upload-area { border: 2px dashed #d1d5db; border-radius: 8px; padding: 24px; text-align: center; background: #f9fafb; cursor: pointer; transition: all 0.2s; }
        .image-upload-area:hover { border-color: #111827; background: #f3f4f6; }
        .image-upload-area.dragover { border-color: #111827; background: #e5e7eb; }
        .image-upload-area input[type="file"] { display: none; }
        .uploaded-images { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px; }
        .uploaded-image-item { position: relative; width: 120px; height: 120px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; }
        .uploaded-image-item img { width: 100%; height: 100%; object-fit: cover; }
        .uploaded-image-item .remove-btn { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .uploaded-image-item .remove-btn:hover { background: rgba(220,38,38,0.9); }
        .upload-progress { margin-top: 8px; font-size: 12px; color: #6b7280; }
        .upload-progress.uploading { color: #111827; }
    </style>
</head>
<body>
    <header>
        <h1>BRAZKE Admin</h1>
        <div style="font-size:13px; color:#d1d5db;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞</div>
    </header>

    <main>
        <section class="card">
            <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ (Supabase)</h2>
            <p class="muted">
                –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Ñ–∞–π–ª <code>admin.html</code> –∏ <code>index.html</code>, –≤—Å—Ç–∞–≤—å —Å–≤–æ–∏
                <strong>SUPABASE_URL</strong> –∏ <strong>SUPABASE_ANON_KEY</strong>, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ Supabase.
            </p>
            <p class="status-text" id="connection-status">–°—Ç–∞—Ç—É—Å: –µ—â—ë –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–ª–∏—Å—å.</p>
        </section>

        <section class="card">
            <h2>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h2>
            <div class="flex-row">
                <p class="muted">–¢–∞–±–ª–∏—Ü–∞ <code>products</code> –≤ Supabase. –°—Ö–µ–º–∞ –Ω–∏–∂–µ.</p>
                <button class="btn btn-primary" id="reload-products-btn">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
            <table class="products-table" id="products-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–†–∞–∑–º–µ—Ä—ã</th>
                        <th>–ì–∞–ª–µ—Ä–µ—è</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="products-tbody">
                    <tr><td colspan="6" class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫¬ª.</td></tr>
                </tbody>
            </table>
        </section>

        <section class="card">
            <div class="flex-row" style="margin-bottom: 16px;">
                <h2 style="margin: 0;">–î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <button type="button" class="btn btn-primary" id="new-product-btn" onclick="resetFormFields()">+ –ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</button>
            </div>
            <p class="muted">–î–ª—è –≥–∞–ª–µ—Ä–µ–∏ –∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.</p>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="field">
                    <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input id="title" type="text" required>
                </div>
                <div class="field">
                    <label for="price">–¶–µ–Ω–∞ (USD)</label>
                    <input id="price" type="number" step="0.01" required>
                </div>
                <div class="field">
                    <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-section">
                    <div class="form-section-title">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞</div>
                    
                    <div class="field">
                        <label>–ì–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                        <div class="image-upload-area" id="main-image-upload" onclick="document.getElementById('main-image-file').click()">
                            <div>üì∑ –ù–∞–∂–º–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
                            <input type="file" id="main-image-file" accept="image/*" onchange="handleMainImageUpload(event)">
                        </div>
                        <input id="main-image" type="text" required style="margin-top: 12px;" placeholder="–ò–ª–∏ –≤—Å—Ç–∞–≤—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                        <img id="main-image-preview" class="image-preview" style="display: none; margin-top: 8px;" alt="Preview">
                        <div class="upload-progress" id="main-image-progress"></div>
                        <div class="hint">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –∏–ª–∏ –≤—Å—Ç–∞–≤–∏—Ç—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>
                    </div>
                    
                    <div class="field">
                        <label>–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</label>
                        <div class="image-upload-area" id="gallery-upload" onclick="document.getElementById('gallery-files').click()">
                            <div>üì∑ –ù–∞–∂–º–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                            <input type="file" id="gallery-files" accept="image/*" multiple onchange="handleGalleryUpload(event)">
                        </div>
                        <div class="uploaded-images" id="gallery-preview"></div>
                        <input id="gallery" type="text" style="margin-top: 12px; display: none;" placeholder="URL —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)">
                        <div class="upload-progress" id="gallery-progress"></div>
                        <div class="hint">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–ª–∏ –≤—Å—Ç–∞–≤–∏—Ç—å URL —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.</div>
                    </div>
                </div>
                <div class="field">
                    <label for="sizes">–†–∞–∑–º–µ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <input id="sizes" type="text">
                    <div class="hint">–ù–∞–ø—Ä–∏–º–µ—Ä: <code>XS,S,M,L,XL</code></div>
                </div>
                <div class="form-section">
                    <div class="form-section-title">–¢–∞–±–ª–∏—Ü–∞ —Ä–∞–∑–º–µ—Ä–æ–≤</div>
                    <div class="field">
                        <label>
                            <input type="checkbox" id="use-size-table" onchange="toggleSizeTableEditor()">
                            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Ä–∞–∑–º–µ—Ä–æ–≤
                        </label>
                    </div>
                    <div id="size-table-editor-container" style="display: none;">
                        <div class="size-table-editor" id="size-table-editor">
                            <div class="size-table-controls">
                                <button type="button" class="btn btn-small btn-primary" onclick="addSizeTableRow()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
                                <button type="button" class="btn btn-small btn-ghost" onclick="resetSizeTable()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                            </div>
                            <div id="size-table-preview"></div>
                        </div>
                    </div>
                    <textarea id="size-table" style="display: none;"></textarea>
                </div>
                <div class="flex-row">
                    <div>
                        <button type="submit" class="btn btn-primary" id="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                        <button type="button" class="btn btn-ghost" id="reset-btn">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
                    </div>
                    <div id="form-status" class="status-text"></div>
                </div>
            </form>
        </section>

        <section class="card">
            <h2>–°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã products (Supabase)</h2>
            <p class="muted">
                –°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É <code>products</code> —Å–æ —Å—Ç–æ–ª–±—Ü–∞–º–∏:
            </p>
            <ul class="muted">
                <li><strong>id</strong> ‚Äì <code>bigint</code>, primary key, auto increment</li>
                <li><strong>title</strong> ‚Äì <code>text</code>, not null</li>
                <li><strong>price</strong> ‚Äì <code>numeric</code>, not null</li>
                <li><strong>description</strong> ‚Äì <code>text</code>, nullable</li>
                <li><strong>main_image</strong> ‚Äì <code>text</code>, not null</li>
                <li><strong>gallery</strong> ‚Äì <code>text[]</code>, nullable</li>
                <li><strong>sizes</strong> ‚Äì <code>text[]</code>, nullable</li>
            </ul>
            <p class="muted">
                –ü–æ—Ç–æ–º –≤–∫–ª—é—á–∏ RLS –∏ –¥–æ–±–∞–≤—å –ø–æ–ª–∏—Ç–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑—Ä–µ—à–∏—Ç—å —á—Ç–µ–Ω–∏–µ –≤—Å–µ–º, –∞ –∑–∞–ø–∏—Å—å —Ç–æ–ª—å–∫–æ —Ç–µ–±–µ —á–µ—Ä–µ–∑ Auth).
            </p>
        </section>
    </main>

    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // –í–ê–ñ–ù–û: –∑–∞–ø–æ–ª–Ω–∏ —Ç–µ –∂–µ –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ –∏ –≤ index.html
        const SUPABASE_URL = 'https://xrlitnxswsiuwntmkmaj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhybGl0bnhzd3NpdXdudG1rbWFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MDYxMDksImV4cCI6MjA4MzE4MjEwOX0.-I_44JSVp7hqY8LiVlwgqXi0WNo-gwmtnL5WXv5dYvw';

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Supabase SDK –∑–∞–≥—Ä—É–∂–µ–Ω
        if (typeof supabase === 'undefined') {
            console.error('Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ CDN.');
        }
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const connectionStatusEl = document.getElementById('connection-status');
        const productsTbody = document.getElementById('products-tbody');
        const reloadBtn = document.getElementById('reload-products-btn');
        const form = document.getElementById('product-form');
        const formStatus = document.getElementById('form-status');

        const productIdInput = document.getElementById('product-id');
        const titleInput = document.getElementById('title');
        const priceInput = document.getElementById('price');
        const descriptionInput = document.getElementById('description');
        const mainImageInput = document.getElementById('main-image');
        const galleryInput = document.getElementById('gallery');
        const sizesInput = document.getElementById('sizes');
        const sizeTableInput = document.getElementById('size-table');
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã —Ä–∞–∑–º–µ—Ä–æ–≤ (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM)
        let useSizeTableCheckbox, sizeTableEditorContainer, sizeTablePreview;
        let sizeTableData = {
            headers: ['–†–∞–∑–º–µ—Ä', 'US', 'FR', 'UK', 'JP'],
            rows: []
        };

        async function testConnectionOnce() {
            try {
                const { error } = await supabaseClient.from('products').select('id').limit(1);
                if (error) {
                    connectionStatusEl.textContent = '–°—Ç–∞—Ç—É—Å: –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è - ' + error.message;
                    connectionStatusEl.style.color = '#b91c1c';
                    console.error('Supabase connection error:', error);
                } else {
                    connectionStatusEl.textContent = '–°—Ç–∞—Ç—É—Å: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ ‚úì';
                    connectionStatusEl.style.color = '#16a34a';
                }
            } catch (err) {
                connectionStatusEl.textContent = '–°—Ç–∞—Ç—É—Å: –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ - ' + err.message;
                connectionStatusEl.style.color = '#b91c1c';
                console.error('Initialization error:', err);
            }
        }

        function renderProductsTable(products) {
            productsTbody.innerHTML = '';
            if (!products || !products.length) {
                productsTbody.innerHTML = '<tr><td colspan="6" class="muted">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</td></tr>';
                return;
            }

            products.forEach(p => {
                const tr = document.createElement('tr');
                const sizesHtml = (p.sizes || []).map(s => `<span class="pill">${s}</span>`).join(' ');
                const galleryCount = (p.gallery || []).length;

                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.title}</td>
                    <td>${p.price}</td>
                    <td>${sizesHtml || '<span class="muted">‚Äî</span>'}</td>
                    <td>${galleryCount ? '<span class="badge">'+galleryCount+' —Ñ–æ—Ç–æ</span>' : '<span class="muted">‚Äî</span>'}</td>
                    <td>
                        <div class="row-actions">
                            <button class="btn btn-ghost" data-action="edit" data-id="${p.id}">–ò–∑–º.</button>
                            <button class="btn btn-danger" data-action="delete" data-id="${p.id}">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </td>
                `;
                productsTbody.appendChild(tr);
            });
        }

        async function loadProducts() {
            reloadBtn.disabled = true;
            reloadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            productsTbody.innerHTML = '<tr><td colspan="6" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .order('id', { ascending: true });

            reloadBtn.disabled = false;
            reloadBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫';

            if (error) {
                console.error(error);
                productsTbody.innerHTML = '<tr><td colspan="6" style="color:#b91c1c;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</td></tr>';
                return;
            }

            renderProductsTable(data || []);
        }

        async function saveProduct(event) {
            event.preventDefault();
            formStatus.textContent = '';
            const id = productIdInput.value ? Number(productIdInput.value) : null;

            // –ü–∞—Ä—Å–∏–º —Ç–∞–±–ª–∏—Ü—É —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑ JSON
            let sizeTable = null;
            const sizeTableValue = sizeTableInput.value.trim();
            if (sizeTableValue) {
                try {
                    sizeTable = JSON.parse(sizeTableValue);
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                    if (!sizeTable.headers || !Array.isArray(sizeTable.headers) || 
                        !sizeTable.rows || !Array.isArray(sizeTable.rows)) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–∞–±–ª–∏—Ü—ã —Ä–∞–∑–º–µ—Ä–æ–≤');
                    }
                } catch (e) {
            formStatus.textContent = '–û—à–∏–±–∫–∞ –≤ JSON —Ç–∞–±–ª–∏—Ü—ã —Ä–∞–∑–º–µ—Ä–æ–≤: ' + e.message;
            formStatus.className = 'status-text error';
            return;
                }
            }

            const payload = {
                title: titleInput.value.trim(),
                price: Number(priceInput.value),
                description: descriptionInput.value.trim() || null,
                main_image: mainImageInput.value.trim(),
                gallery: galleryImages.length > 0 
                    ? galleryImages 
                    : (galleryInput.value.trim()
                        ? galleryInput.value.split(',').map(x => x.trim()).filter(Boolean)
                        : []),
                sizes: sizesInput.value.trim()
                    ? sizesInput.value.split(',').map(x => x.trim()).filter(Boolean)
                    : [],
                size_table: sizeTable
            };

            if (!payload.title || !payload.main_image || Number.isNaN(payload.price)) {
                formStatus.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞, –≥–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ).';
                formStatus.className = 'status-text error';
                return;
            }
            
            if (payload.price <= 0) {
                formStatus.textContent = '‚ùå –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.';
                formStatus.className = 'status-text error';
                return;
            }

            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            let error;
            if (id) {
                const res = await supabaseClient.from('products').update(payload).eq('id', id).select();
                error = res.error;
            } else {
                const res = await supabaseClient.from('products').insert(payload).select();
                error = res.error;
            }

            saveBtn.disabled = false;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä';

            if (error) {
                console.error('Save error:', error);
                let errorMsg = `‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                if (error.details) {
                    errorMsg += `\n–î–µ—Ç–∞–ª–∏: ${error.details}`;
                    console.error('Error details:', error.details);
                }
                if (error.hint) {
                    errorMsg += `\n–ü–æ–¥—Å–∫–∞–∑–∫–∞: ${error.hint}`;
                    console.error('Error hint:', error.hint);
                }
                formStatus.textContent = errorMsg;
                formStatus.className = 'status-text error';
                alert(errorMsg + '\n\n–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
                return;
            }

            formStatus.textContent = id ? '‚úì –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω —É—Å–ø–µ—à–Ω–æ!' : '‚úì –¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!';
            formStatus.className = 'status-text success';
            await loadProducts();
            setTimeout(() => {
                resetFormFields();
            }, 1000);
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã —Ä–∞–∑–º–µ—Ä–æ–≤
        function toggleSizeTableEditor() {
            if (!useSizeTableCheckbox || !sizeTableEditorContainer) return;
            if (useSizeTableCheckbox.checked) {
                sizeTableEditorContainer.style.display = 'block';
                renderSizeTableEditor();
            } else {
                sizeTableEditorContainer.style.display = 'none';
                sizeTableInput.value = '';
            }
        }
        
        function renderSizeTableEditor() {
            if (!sizeTablePreview) return;
            let html = '<table><thead><tr>';
            sizeTableData.headers.forEach((header, idx) => {
                html += `<th><input type="text" value="${header || ''}" onchange="updateSizeTableHeader(${idx}, this.value)" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"></th>`;
            });
            html += '<th></th></tr></thead><tbody id="size-table-rows">';
            
            sizeTableData.rows.forEach((row, rowIdx) => {
                html += '<tr>';
                sizeTableData.headers.forEach((_, cellIdx) => {
                    const cellValue = row[cellIdx] || '';
                    html += `<td><input type="text" value="${cellValue}" onchange="updateSizeTableCell(${rowIdx}, ${cellIdx}, this.value)"></td>`;
                });
                html += `<td><button type="button" class="btn btn-small btn-danger" onclick="removeSizeTableRow(${rowIdx})">√ó</button></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            sizeTablePreview.innerHTML = html;
            updateSizeTableJSON();
        }
        
        function addSizeTableRow() {
            const newRow = sizeTableData.headers.map(() => '');
            sizeTableData.rows.push(newRow);
            renderSizeTableEditor();
        }
        
        function removeSizeTableRow(index) {
            sizeTableData.rows.splice(index, 1);
            renderSizeTableEditor();
        }
        
        function updateSizeTableHeader(index, value) {
            sizeTableData.headers[index] = value;
            updateSizeTableJSON();
        }
        
        function updateSizeTableCell(rowIndex, cellIndex, value) {
            if (!sizeTableData.rows[rowIndex]) {
                sizeTableData.rows[rowIndex] = [];
            }
            sizeTableData.rows[rowIndex][cellIndex] = value;
            updateSizeTableJSON();
        }
        
        function resetSizeTable() {
            sizeTableData = {
                headers: ['–†–∞–∑–º–µ—Ä', 'US', 'FR', 'UK', 'JP'],
                rows: []
            };
            renderSizeTableEditor();
        }
        
        function updateSizeTableJSON() {
            if (sizeTableInput) {
                sizeTableInput.value = JSON.stringify(sizeTableData, null, 2);
            }
        }

        function resetFormFields() {
            productIdInput.value = '';
            titleInput.value = '';
            priceInput.value = '';
            descriptionInput.value = '';
            mainImageInput.value = '';
            updateMainImagePreview('');
            galleryImages = [];
            updateGalleryPreview();
            updateGalleryInput();
            sizesInput.value = '';
            sizeTableInput.value = '';
            if (useSizeTableCheckbox) {
                useSizeTableCheckbox.checked = false;
                toggleSizeTableEditor();
            }
            resetSizeTable();
            formStatus.textContent = '';
            formStatus.className = 'status-text';
            
            // –û—á–∏—â–∞–µ–º –∏–Ω–ø—É—Ç—ã —Ñ–∞–π–ª–æ–≤
            document.getElementById('main-image-file').value = '';
            document.getElementById('gallery-files').value = '';
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
            const form = document.getElementById('product-form');
            if (form) {
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        

        async function deleteProduct(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä #' + id + '?')) return;
            const { error } = await supabaseClient.from('products').delete().eq('id', id);
            if (error) {
                console.error(error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞. –°–º. –∫–æ–Ω—Å–æ–ª—å.');
                return;
            }
            await loadProducts();
        }

        async function fillFormFromProductId(id) {
            const { data, error } = await supabaseClient.from('products').select('*').eq('id', id).maybeSingle();
            if (error || !data) {
                console.error(error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
                return;
            }

            productIdInput.value = data.id;
            titleInput.value = data.title || '';
            priceInput.value = data.price || '';
            descriptionInput.value = data.description || '';
            mainImageInput.value = data.main_image || '';
            galleryInput.value = (data.gallery || []).join(', ');
            sizesInput.value = (data.sizes || []).join(', ');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–∞–∑–º–µ—Ä–æ–≤
            if (data.size_table) {
                sizeTableData = data.size_table;
                useSizeTableCheckbox.checked = true;
                toggleSizeTableEditor();
            } else {
                useSizeTableCheckbox.checked = false;
                toggleSizeTableEditor();
            }
            
            formStatus.textContent = '‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ #' + data.id;
            formStatus.className = 'status-text';
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
            document.getElementById('product-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // –°–ª—É—à–∞—Ç–µ–ª–∏
        reloadBtn.addEventListener('click', loadProducts);
        form.addEventListener('submit', saveProduct);
        document.getElementById('reset-btn').addEventListener('click', resetFormFields);

        productsTbody.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.getAttribute('data-action');
            const id = Number(btn.getAttribute('data-id'));
            if (!id) return;

            if (action === 'edit') {
                fillFormFromProductId(id);
            } else if (action === 'delete') {
                deleteProduct(id);
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        async function handleMainImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const progressEl = document.getElementById('main-image-progress');
            progressEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            progressEl.className = 'upload-progress uploading';
            
            try {
                const url = await uploadImageToStorage(file, `main-${Date.now()}-${file.name}`);
                mainImageInput.value = url;
                updateMainImagePreview(url);
                progressEl.textContent = '‚úì –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ';
                progressEl.className = 'upload-progress';
            } catch (error) {
                console.error('Upload error:', error);
                progressEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
                progressEl.className = 'upload-progress';
            }
        }
        
        async function handleGalleryUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            const progressEl = document.getElementById('gallery-progress');
            progressEl.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ ${files.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...`;
            progressEl.className = 'upload-progress uploading';
            
            try {
                const uploadPromises = files.map((file, index) => 
                    uploadImageToStorage(file, `gallery-${Date.now()}-${index}-${file.name}`)
                );
                const urls = await Promise.all(uploadPromises);
                
                galleryImages.push(...urls);
                updateGalleryPreview();
                updateGalleryInput();
                
                progressEl.textContent = `‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${urls.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`;
                progressEl.className = 'upload-progress';
            } catch (error) {
                console.error('Upload error:', error);
                progressEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
                progressEl.className = 'upload-progress';
            }
        }
        
        async function uploadImageToStorage(file, fileName) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ Supabase Storage
            const { data, error } = await supabaseClient.storage
                .from(STORAGE_BUCKET)
                .upload(fileName, file, {
                    cacheControl: '3600',
                    upsert: false
                });
            
            if (error) {
                throw new Error(error.message);
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL
            const { data: { publicUrl } } = supabaseClient.storage
                .from(STORAGE_BUCKET)
                .getPublicUrl(data.path);
            
            return publicUrl;
        }
        
        async function deleteImageFromStorage(imageUrl) {
            try {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—É—Ç—å –∏–∑ URL
                const urlParts = imageUrl.split('/');
                const fileName = urlParts[urlParts.length - 1].split('?')[0];
                
                const { error } = await supabaseClient.storage
                    .from(STORAGE_BUCKET)
                    .remove([fileName]);
                
                if (error) {
                    console.error('Delete error:', error);
                }
            } catch (error) {
                console.error('Error deleting image:', error);
            }
        }
        
        function updateMainImagePreview(url) {
            const preview = document.getElementById('main-image-preview');
            if (url && preview) {
                preview.src = url;
                preview.style.display = 'block';
            } else if (preview) {
                preview.style.display = 'none';
            }
        }
        
        function updateGalleryPreview() {
            const container = document.getElementById('gallery-preview');
            container.innerHTML = '';
            
            galleryImages.forEach((url, index) => {
                const item = document.createElement('div');
                item.className = 'uploaded-image-item';
                item.innerHTML = `
                    <img src="${url}" alt="Gallery image ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removeGalleryImage(${index})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                `;
                container.appendChild(item);
            });
        }
        
        function removeGalleryImage(index) {
            const url = galleryImages[index];
            deleteImageFromStorage(url);
            galleryImages.splice(index, 1);
            updateGalleryPreview();
            updateGalleryInput();
        }
        
        function updateGalleryInput() {
            galleryInput.value = galleryImages.join(', ');
        }
        
        // Drag and drop –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
        function setupDragAndDrop() {
            const mainUploadArea = document.getElementById('main-image-upload');
            const galleryUploadArea = document.getElementById('gallery-upload');
            
            [mainUploadArea, galleryUploadArea].forEach(area => {
                if (!area) return;
                
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragover');
                });
                
                area.addEventListener('dragleave', () => {
                    area.classList.remove('dragover');
                });
                
                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragover');
                    
                    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                    if (files.length === 0) return;
                    
                    if (area === mainUploadArea) {
                        const fileInput = document.getElementById('main-image-file');
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(files[0]);
                        fileInput.files = dataTransfer.files;
                        handleMainImageUpload({ target: fileInput });
                    } else {
                        const fileInput = document.getElementById('gallery-files');
                        const dataTransfer = new DataTransfer();
                        files.forEach(f => dataTransfer.items.add(f));
                        fileInput.files = dataTransfer.files;
                        handleGalleryUpload({ target: fileInput });
                    }
                });
            });
        }
        
        // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - –∂–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ SDK –∏ DOM
        window.addEventListener('DOMContentLoaded', async () => {
            if (typeof supabase === 'undefined') {
                connectionStatusEl.textContent = '–°—Ç–∞—Ç—É—Å: –æ—à–∏–±–∫–∞ - Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
                connectionStatusEl.style.color = '#b91c1c';
                return;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã —Ä–∞–∑–º–µ—Ä–æ–≤
            useSizeTableCheckbox = document.getElementById('use-size-table');
            sizeTableEditorContainer = document.getElementById('size-table-editor-container');
            sizeTablePreview = document.getElementById('size-table-preview');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if (mainImageInput) {
                mainImageInput.addEventListener('input', function() {
                    updateMainImagePreview(this.value);
                });
            }
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º drag and drop
            setupDragAndDrop();
            
            await testConnectionOnce();
            await loadProducts();
        });
    </script>
</body>
</html>


